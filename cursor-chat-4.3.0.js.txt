// ==UserScript==
// @name         cursor-chat
// @namespace    https://tampermonkey.net/
// @version      4.3.0
// @description  ÈõÜÊàêËÅäÂ§©ÁïåÈù¢ÔºàÂØºËà™Ê†èÈõÜÊàê„ÄÅËÉåÊôØÊ®°Á≥ä„ÄÅËá™Âä®ÊâìÂºÄ„ÄÅÊ®°ÂûãÂàáÊç¢ÔºâÔºõÊîØÊåÅGPT-5/Claude Opus 4.1/Sonnet 4/Gemini 2.5 Pro/DeepSeek V3.1Á≠âÊ®°ÂûãÂàáÊç¢Ôºõ‰ºöËØùÂàóË°®„ÄÅMarkdown Ê∞îÊ≥°„ÄÅ‰ª£Á†ÅÂùóÂ§çÂà∂„ÄÅÂ§çÂà∂/Âà†Èô§/ÈáçÊñ∞ÁîüÊàê/ÁªßÁª≠„ÄÅÂèëÈÄÅ/ÂÅúÊ≠¢ÂàáÊç¢„ÄÅÂÅúÊ≠¢‰øùÁïôÈÉ®ÂàÜÔºõÊØè‰∏™‰ºöËØùÁã¨Á´ãÂèëÈÄÅ/ÂÅúÊ≠¢Ôºõ
// @match        https://cursor.com/zh/learn*
// @match        https://cursor.com/en-US/learn*
// @match        https://cursor.com/cn/learn*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  /** ========= ÈÖçÁΩÆ ========= **/
  const BASE_GLOBAL_INSTRUCTION = 'ÂêéÁª≠ÂõûÁ≠î‰∏çÈúÄË¶ÅËØªÂèñÂΩìÂâçÁ´ôÁÇπÁöÑÁü•ËØÜ\n';
  const CUSTOM_PROMPT_KEY = 'cursor_overlay_custom_prompt';
  let customSystemPrompt = '';
  const FORCE_OVERRIDE_ON_UPSTREAM = true;     // Áî® upstream ÊõøÊç¢ /api/chat ÁöÑ messages
  const INJECT_TO_FIRST_USER_TOO   = true;     // ÊòØÂê¶ÊääÂÖ®Â±ÄÊåá‰ª§‰πüÂâçÁºÄÂ°ûÁªôÁ¨¨‰∏ÄÊù° user
  const UI_HOTKEY = { ctrlKey: true, altKey: true, key: 'c' }; // Ctrl+Alt+C
  const FAST_SEND = true;                      // Áõ¥Ëøû /api/chatÔºõfalse ÂàôÂ∞ùËØïÊ®°ÊãüÁÇπÂáª
  const DEFAULT_MODEL = 'claude-sonnet-4-20250514';
  const DEBUG = false;

  // ÂèØÁî®Ê®°ÂûãÂàóË°®
  const AVAILABLE_MODELS = [
    { value: 'gpt-5', name: 'GPT-5', provider: 'OpenAI' },
    { value: 'claude-opus-4-1-20250805', name: 'Claude Opus 4.1', provider: 'Anthropic' },
    { value: 'claude-opus-4-20250514', name: 'Claude Opus 4', provider: 'Anthropic' },
    { value: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4', provider: 'Anthropic' },
    { value: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', provider: 'Google' },
    { value: 'deepseek-v3.1', name: 'DeepSeek V3.1', provider: 'DeepSeek' }
  ];

  // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã
  function getCurrentModel() {
    return localStorage.getItem('cursor_overlay_selected_model') || DEFAULT_MODEL;
  }

  // ‰øùÂ≠òÊ®°ÂûãÈÄâÊã©
  function saveModelSelection(model) {
    localStorage.setItem('cursor_overlay_selected_model', model);
    console.log(`[Ê®°ÂûãÂàáÊç¢] Â∑≤ÂàáÊç¢Âà∞: ${model}`);
  }

  // Ëé∑ÂèñÊ®°ÂûãÊòæÁ§∫ÂêçÁß∞
  function getModelDisplayName(modelValue) {
    const model = AVAILABLE_MODELS.find(m => m.value === modelValue);
    return model ? `${model.name}` : modelValue;
  }

  // Ëé∑ÂèñÊ®°ÂûãÁÆÄÁü≠ÂêçÁß∞ÔºàÁî®‰∫éÊ∞îÊ≥°ÊòæÁ§∫Ôºâ
  function getModelShortName(modelValue) {
    const model = AVAILABLE_MODELS.find(m => m.value === modelValue);
    return model ? model.name : modelValue;
  }

  // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®
  function initModelSelector(selectElement) {
    if (!selectElement) return;

    loadCustomPrompt();

    // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã
    const currentModel = getCurrentModel();
    selectElement.value = currentModel;

    // ÁõëÂê¨Ê®°ÂûãÈÄâÊã©ÂèòÂåñ
    selectElement.addEventListener('change', (e) => {
      const selectedModel = e.target.value;
      saveModelSelection(selectedModel);

      // Êõ¥Êñ∞UIÊòæÁ§∫ÂΩìÂâçÊ®°Âûã
      const displayName = getModelDisplayName(selectedModel);
      console.log(`[Ê®°ÂûãÂàáÊç¢] Áî®Êà∑ÂàáÊç¢Âà∞: ${displayName}`);
    });

    const displayName = getModelDisplayName(currentModel);
    console.log(`[Ê®°ÂûãÈÄâÊã©Âô®] ÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâçÊ®°Âûã: ${displayName}`);
  }

  // Êó•ÊúüÊ†ºÂºèÂåñÂáΩÊï∞
  function formatDate(isoString) {
    if (!isoString) return 'Êú™Áü•Êó∂Èó¥';
    const date = new Date(isoString);
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const itemDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    if (itemDate.getTime() === today.getTime()) {
      // ‰ªäÂ§©ÔºåÊòæÁ§∫ÂÆåÊï¥ÁöÑÂπ¥ÊúàÊó• + Êó∂Èó¥
      const dateStr = date.getFullYear() + 'Âπ¥' + (date.getMonth() + 1) + 'Êúà' + date.getDate() + 'Êó•';
      const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      return dateStr + ' ' + timeStr;
    } else if (itemDate.getTime() === today.getTime() - 24 * 60 * 60 * 1000) {
      // Êò®Â§©
      return 'Êò®Â§© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    } else if (date.getFullYear() === now.getFullYear()) {
      // ÂêåÂπ¥ÔºåÊòæÁ§∫ÊúàÊó•
      return (date.getMonth() + 1) + 'Êúà' + date.getDate() + 'Êó•';
    } else {
      // ‰∏çÂêåÂπ¥ÔºåÊòæÁ§∫Âπ¥ÊúàÊó•
      return date.getFullYear() + 'Âπ¥' + (date.getMonth() + 1) + 'Êúà' + date.getDate() + 'Êó•';
    }
  }

  /** ========= Â∞èÂ∑•ÂÖ∑ ========= **/
  const isArr = Array.isArray;
  const nowISO = () => new Date().toISOString();
  const uid = (p='id') => p + '_' + Math.random().toString(16).slice(2);
  const log = (...a)=>{ if (DEBUG) console.log('[overlay]', ...a); };

  const escHtml = s => String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));

  function readText(msg) {
    if (!msg) return '';
    if (typeof msg.content === 'string') return msg.content;
    if (isArr(msg.parts)) return msg.parts.find(p => p?.type === 'text')?.text ?? '';
    return '';
  }
  function ensureGlobalSystem(history) {
    // ‰∏çÂÜçÊ∑ªÂä†Áã¨Á´ãÁöÑ system Ê∂àÊÅØÔºåÁõ¥Êé•ËøîÂõûÂéüÂßãÂàóË°®
    return isArr(history) ? [...history] : [];
  }
  function injectToFirstUser(list) {
    const instruction = getGlobalInstruction();
    if (!instruction) return list;
    const idx = list.findIndex(m => m?.role === 'user');
    if (idx === -1) return list;
    const t = list[idx].content || '';
    const re = new RegExp('^' + instruction.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
    list[idx] = { role:'user', content: instruction + t.replace(re, '') };
    return list;
  }

  /** ========= Markdown Ê∏≤ÊüìÔºàÂÆûÊó∂ + Á¥ßÂáë + Tailwind ÊîØÊåÅÔºâ ========= **/
  function renderMD(md) {
    if (md == null) return '';

    // 1) ÂÖàÂç†‰Ωç‰ª£Á†ÅÔºàÂ§öË°å‰∏éË°åÂÜÖÔºâÔºåÈÅøÂÖçÂêéÁª≠ÊõøÊç¢Ê±°Êüì‰ª£Á†ÅÂÜÖÂÆπ
    const fenceBlocks = [];
    const inlineCodes = [];
    let src = String(md);

    // Âç†‰ΩçÂ§öË°å‰ª£Á†ÅÂùó ```lang\n...\n```
    src = src.replace(/```([\w-]+)?\n([\s\S]*?)```/g, (m, lang, code) => {
      const idx = fenceBlocks.length;
      fenceBlocks.push({ lang: lang || 'code', code: code || '' });
      return `@@FENCEBLOCK${idx}@@`;
    });

    // Âç†‰ΩçË°åÂÜÖ‰ª£Á†Å `...`
    src = src.replace(/`([^`]+)`/g, (m, code) => {
      const idx = inlineCodes.length;
      inlineCodes.push(code || '');
      return `@@INLINECODE${idx}@@`;
    });

    // 2) ÂØπÈùû‰ª£Á†ÅÂÜÖÂÆπËΩ¨‰πâ + ËΩªÈáè Markdown Ê∏≤Êüì
    let s = escHtml(src);

    // Ê†áÈ¢òÔºàÁ¥ßÂáëÔºâ
    s = s.replace(/^(######)\s?(.*)$/gm, '<h6>$2</h6>')
         .replace(/^(#####)\s?(.*)$/gm, '<h5>$2</h5>')
         .replace(/^(####)\s?(.*)$/gm, '<h4>$2</h4>')
         .replace(/^(###)\s?(.*)$/gm, '<h3>$2</h3>')
         .replace(/^(##)\s?(.*)$/gm, '<h2>$2</h2>')
         .replace(/^(#)\s?(.*)$/gm, '<h1>$2</h1>');

    // Á≤ó‰Ωì/Êñú‰ΩìÔºà‰∏ç‰ºö‰ΩúÁî®Âà∞‰ª£Á†ÅÔºåÂõ†‰∏∫‰ª£Á†ÅÂ∑≤Ë¢´Âç†‰ΩçÔºâ
    s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
         .replace(/\*([^*]+)\*/g, '<em>$1</em>')
         .replace(/__([^_]+)__/g, '<strong>$1</strong>')
         .replace(/_([^_]+)_/g, '<em>$1</em>');

    // ÈìæÊé•
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

    // È´ò‰∫ÆÊñáÊú¨Ôºà==ÊñáÊú¨==Ôºâ
    s = s.replace(/==([^=]+)==/g, '<mark class="tw-bg-yellow-200 tw-px-1 tw-rounded">$1</mark>');

    // ÊèêÁ§∫Ê°Ü
    s = s.replace(/:::tip\s*\n([\s\S]*?)\n:::/g, '<div class="tw-bg-blue-100 tw-border-blue-500 tw-border-l-4 tw-p-2 tw-my-1 tw-rounded"><div class="tw-text-blue-800 tw-text-sm">üí° $1</div></div>')
         .replace(/:::warning\s*\n([\s\S]*?)\n:::/g, '<div class="tw-bg-yellow-100 tw-border-yellow-500 tw-border-l-4 tw-p-2 tw-my-1 tw-rounded"><div class="tw-text-yellow-800 tw-text-sm">‚ö†Ô∏è $1</div></div>')
         .replace(/:::danger\s*\n([\s\S]*?)\n:::/g, '<div class="tw-bg-red-100 tw-border-red-500 tw-border-l-4 tw-p-2 tw-my-1 tw-rounded"><div class="tw-text-red-800 tw-text-sm">üö´ $1</div></div>');

    // ÊîØÊåÅ Tailwind Á±ªÊ†áËÆ∞Ôºà{.class-name}Ôºâ
    s = s.replace(/\{\.([^}]+)\}/g, ' class="$1"');

    // ÂàóË°®ÔºàÊó†Â∫èÔºâ
    s = s.replace(/(^|\n)\s*[-*]\s+([^\n]+)/g, '$1__UL_ITEM__$2__/UL_ITEM__');
    s = s.replace(/(__UL_ITEM__[\s\S]*?__\/UL_ITEM__)+/g, (match) => {
      const items = match.match(/__UL_ITEM__(.*?)__\/UL_ITEM__/g) || [];
      const listItems = items.map(item => {
        const content = item.replace(/__UL_ITEM__|__\/UL_ITEM__/g, '').trim();
        return `<li>${content}</li>`;
      }).join('');
      return `<ul>${listItems}</ul>`;
    });

    // ÂàóË°®ÔºàÊúâÂ∫èÔºâ
    s = s.replace(/(^|\n)\s*\d+\.\s+([^\n]+)/g, '$1__OL_ITEM__$2__/OL_ITEM__');
    s = s.replace(/(__OL_ITEM__[\s\S]*?__\/OL_ITEM__)+/g, (match) => {
      const items = match.match(/__OL_ITEM__(.*?)__\/OL_ITEM__/g) || [];
      const listItems = items.map(item => {
        const content = item.replace(/__OL_ITEM__|__\/OL_ITEM__/g, '').trim();
        return `<li>${content}</li>`;
      }).join('');
      return `<ol>${listItems}</ol>`;
    });

    // Ê∞¥Âπ≥Á∫ø‰∏éÊç¢Ë°å
    s = s.replace(/(^|\n)---+\s*$/gm, '$1<hr/>' );
    s = s.replace(/\n/g, '<br/>' );

    // 3) ËøòÂéüË°åÂÜÖ‰ª£Á†ÅÂç†‰Ωç
    s = s.replace(/@@INLINECODE(\d+)@@/g, (m, i) => {
      const code = inlineCodes[+i] || '';
      return `<code class="code-inline">${escHtml(code)}</code>`;
    });

    // 4) ËøòÂéüÂ§öË°å‰ª£Á†ÅÂùóÂç†‰ΩçÔºàÊòæÁ§∫ËΩ¨‰πâÔºåÂ§çÂà∂Áî®ÂéüÂßãÔºâ
    s = s.replace(/@@FENCEBLOCK(\d+)@@/g, (m, i) => {
      const b = fenceBlocks[+i] || { lang: 'code', code: '' };
      const lang = b.lang || 'code';
      const code = b.code || '';
      const rawHtml = escHtml(code);
      const data = encodeURIComponent(code);
      const totalLines = code.split('\n').length;
      const nonEmptyLines = code.split('\n').filter(line => line.trim()).length;
      const lines = totalLines;
      const isLong = lines >= 5;
      console.log(`[MDÊ∏≤Êüì] ‰ª£Á†ÅÂùó: ÊÄªË°åÊï∞=${totalLines}, ÈùûÁ©∫Ë°åÊï∞=${nonEmptyLines}, ‰ΩøÁî®Ë°åÊï∞=${lines}, ÈúÄË¶ÅÊäòÂè†=${isLong}`);
      const toggleBtn = isLong ? `<button class="toggle-code" title="Â±ïÂºÄ/ÊäòÂè†">Â±ïÂºÄ</button>` : '';
      const collapsedClass = isLong ? ' collapsed' : '';
      return `
        <div class="code-wrap" data-lines="${lines}">
          <div class="code-head">
            <span class="lang">${escHtml(lang)}</span>
            <span class="code-buttons">
              <button class="copy-code" data-raw="${data}" title="Â§çÂà∂‰ª£Á†Å">Â§çÂà∂</button>
              ${toggleBtn}
            </span>
          </div>
          <pre class="code-block${collapsedClass}"><code data-lang="${escHtml(lang)}">${rawHtml}</code></pre>
        </div>`;
    });

    return s;
  }

  /** ========= Êú¨Âú∞Â≠òÂÇ® ========= **/
  const STORE_KEY = 'cursor_overlay_chats_v5';
  const state = {
    conversations: {},   // id -> { id, title, createdAt, updatedAt, messages:[{id, role, content, ts, status?}] }
    activeId: null,
    // Êñá‰ª∂‰∏ä‰º†Áä∂ÊÄÅ
    uploadedFile: null, // { name, content }
  };
  function loadStore() {
    try {
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === 'object') {
        state.conversations = obj.conversations || {};
        state.activeId = obj.activeId || Object.keys(state.conversations)[0] || null;
      }
    } catch {}
  }
  function saveStore() { try { localStorage.setItem(STORE_KEY, JSON.stringify(state)); } catch{} }

  function createConversation(title='Êñ∞ÂØπËØù') {
    const id = uid('conv');
    state.conversations[id] = { id, title, createdAt: nowISO(), updatedAt: nowISO(), messages: [] };
    state.activeId = id;
    saveStore(); renderSidebar(); renderMessages(); renderHeader();
  }
  function deleteConversation(id) {
    if (!state.conversations[id]) return;
    delete state.conversations[id];
    if (state.activeId === id) state.activeId = Object.keys(state.conversations)[0] || null;
    saveStore(); renderSidebar(); renderMessages(); renderHeader(); updateSendButtonUI();
  }
  function renameConversation(id, title) {
    const c = state.conversations[id]; if (!c) return;
    c.title = title || c.title;
    c.updatedAt = nowISO();
    saveStore(); renderSidebar(); renderHeader();
  }

  /** ========= ÊØè‰ºöËØùËøêË°åÊÄÅ ========= **/
  const convRuntime = new Map();
  // convId -> { isGenerating, controller, curAssistant:{node,content,targetIndex}, listener, collapseTimer }
  function getRT(convId) {
    if (!convRuntime.has(convId)) {
      convRuntime.set(convId, {
        isGenerating: false,
        controller: null,
        curAssistant: { node:null, content:'', targetIndex:null },
        listener: null,
        collapseTimer: null, // Èò≤ÊäñËÆ°Êó∂Âô®
      });
    }
    return convRuntime.get(convId);
  }

  // Ê∏ÖÁêÜÊåáÂÆö‰ºöËØùÁöÑÁõëÂê¨Âô®
  function cleanupListenerForConv(convId) {
    const rt = getRT(convId);
    if (rt.listener) {
      // Ê†áËÆ∞ÁõëÂê¨Âô®‰∏∫ÈùûÊ¥ªË∑ÉÁä∂ÊÄÅ
      rt.listener.active = false;
      // ‰ªéÂÖ®Â±ÄÁõëÂê¨Âô®ÈõÜÂêà‰∏≠ÁßªÈô§
      bridge.listeners.delete(rt.listener);
      const orderIndex = bridge.order.indexOf(rt.listener);
      if (orderIndex > -1) {
        bridge.order.splice(orderIndex, 1);
      }
      rt.listener = null;
      console.log(`[Âπ∂Ë°åÂØπËØù] Ê∏ÖÁêÜ‰ºöËØù ${convId} ÁöÑÁõëÂê¨Âô®`);
    }
  }

  /** ========= UI ========= **/
  let root, $sidebar, $messages, $input, $send, $usage, $title, $toggleBtn;
  function injectUI() {
    if (root) return;
    root = document.createElement('div');
    root.id = 'cursor-chat-overlay-root';
    root.attachShadow({ mode: 'open' });

    const style = document.createElement('style');

    style.textContent = `
      :host, .wrap { all: initial; font: 13.5px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .wrap { position: fixed; inset-block: 24px;;inset-inline: 224px; z-index: 2147483000; display: none; }
      .backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); z-index: 2147482999; display: none; }
      .app { width: 100%; height: 100%; display: grid; grid-template-columns: 260px 1fr; gap: 10px; }
      .card { background: #fff; border: 1px solid rgba(0,0,0,.08); border-radius: 14px; box-shadow: 0 6px 14px rgba(0,0,0,.05); overflow: hidden; }
      .sidebar { display: flex; flex-direction: column; }
      .side-head { display:flex; align-items:center; justify-content: space-between; padding: 8px 10px; border-bottom:1px solid rgba(0,0,0,.06); }
      .search { margin: 6px 10px; }
      .search input { width:100%; padding:7px 9px; border:1px solid #e5e7eb; border-radius:9px; }
      .list { flex:1; overflow:auto; padding: 4px; }
      .item { padding:8px 9px; border-radius:10px; cursor:pointer; }
      .item-title { font-weight:500; margin-bottom:2px; }
      .item-date { font-size:11px; color:#6b7280; }
      .item:hover { background:#f6f7fb; }
      .item.active { background:#eef2ff; border:1px solid #c7d2fe; }
      .item-main { display:flex; align-items:center; justify-content:space-between; gap:6px; }
      .item-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .item-icons { display:flex; gap:4px; }
      .item-icon { border:none; background:transparent; padding:2px 6px; border-radius:6px; cursor:pointer; color:#6b7280; font-size:12px; }
      .item-icon:hover { background:#e5e7eb; color:#374151; }
      .item-icon.confirm { color:#166534; background:#dcfce7; }
      .item-rename-input { flex:1; padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; }
      .item.editing .item-icons { display:none; }
      .main { display: grid; grid-template-rows: 46px 1fr auto; }
      .head { display:flex; align-items:center; justify-content: space-between; padding: 8px 12px; border-bottom:1px solid rgba(0,0,0,.06); flex-wrap: wrap; gap: 8px; }
      .head .title { font-weight:600; }
      .head .model-selector { display: flex; align-items: center; gap: 6px; }
      .head .model-selector select { padding: 4px 6px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 11px; background: #fff; cursor: pointer; }
      .head .model-selector label { font-size: 11px; color: #6b7280; font-weight: 500; }
      .usage { font-size:12px; color:#6b7280; }
      .msgs { overflow:auto; padding: 12px; background:#fafafa; }
      .bubble { padding: 8px 10px; border-radius: 12px; margin: 8px 0; white-space: normal; word-break: break-word; position: relative; }
      .bubble.user { max-width: fit-content; margin-left: auto; background:#e0f2fe; border:1px solid #bae6fd; }
      .bubble.assistant { max-width: none; margin: 8px 0; background: none; border: none; padding: 0; }
      .bubble .content { line-height: 1.45; }
      .bubble .content p { margin: .05em 0; }
      .bubble .content :is(h1,h2,h3,h4,h5,h6){ margin: .1em 0 .05em; line-height:1.2; }
      .bubble .content ul, .bubble .content ol { margin: .05em .8em; }
      .bubble .content li { margin: .025em 0; }
      .bubble .content a { color:#2563eb; text-decoration: none; }
      .bubble .content a:hover { text-decoration: underline; }
      .bubble .content hr { margin: .1em 0; border: none; border-top: 1px solid #e5e7eb; }
      .bubble .content strong { font-weight: 600; }
      .bubble .content em { font-style: italic; }
      .bubble .content code.code-inline { background:#f3f4f6; padding: 1px 4px; border-radius: 5px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .bubble .content .code-wrap { border:1px solid #e5e7eb; border-radius:9px; overflow:hidden; margin:.08em 0; }
      .bubble .content .code-head { display:flex; justify-content:space-between; align-items:center; font-size:12px; padding:5px 7px; background:#f9fafb; border-bottom:1px solid #e5e7eb; }
      .bubble .content .code-head .lang { color:#6b7280; }
      .bubble .content .code-head .code-buttons { display:flex; gap:4px; }
      .bubble .content .code-head .copy-code, .bubble .content .code-head .toggle-code { cursor:pointer; border:1px solid #e5e7eb; background:#fff; border-radius:7px; padding:2px 8px; font-size:11px; }
      .bubble .content pre.code-block { margin:0; background:#0b1020; color:#f5f7ff; padding: 9px; overflow:auto; font-size: 12.5px; transition: max-height 0.3s ease-out; }
      .bubble .content pre.code-block.collapsed {
        max-height: 150px;
        position: relative;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #374151 #1f2937;
      }
      .bubble .content pre.code-block.collapsed::-webkit-scrollbar { width: 6px; }
      .bubble .content pre.code-block.collapsed::-webkit-scrollbar-track { background: #1f2937; border-radius: 3px; }
      .bubble .content pre.code-block.collapsed::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
      .bubble .content pre.code-block.collapsed::-webkit-scrollbar-thumb:hover { background: #4b5563; }
      .bubble .content pre.code-block.collapsed::after {
        content:'';
        position:absolute;
        bottom:0;
        left:0;
        right:6px;
        height:20px;
        background:linear-gradient(transparent, #0b1020);
        pointer-events:none;
        opacity: 0.7;
      }
      .status { display:inline-block; padding:1px 6px; border-radius:6px; font-size:11px; margin-left:6px; background:#f3f4f6; color:#6b7280; }
      .meta { display:flex; gap:10px; align-items:center; margin-top:4px; font-size:12px; color:#6b7280; flex-wrap: wrap; }
      .tools { display:flex; gap:8px; }
      .tool { cursor:pointer; color:#2563eb; }
      .tool:hover { text-decoration: underline; }
      .foot { padding: 9px; border-top:1px solid rgba(0,0,0,.06); }
      .input { display:flex; gap:8px; align-items: flex-end; }
      textarea { flex:1; min-height: 48px; max-height: 160px; padding:9px 10px; border-radius:10px; border:1px solid #e5e7eb; resize: vertical; }
      .send { padding: 9px 14px; border-radius:10px; border:1px solid #16a34a; background:#22c55e; color:white; cursor:pointer; }
      .send:disabled { opacity:.5; cursor:not-allowed; }
      .upload-btn { padding: 9px; border-radius:10px; border:1px solid #6b7280; background:#f9fafb; color:#374151; cursor:pointer; position:relative; }
      .upload-btn:hover { background:#f3f4f6; }
      .upload-btn.has-file { background:#dbeafe; border-color:#3b82f6; color:#1e40af; }
      .file-input { display: none; }
      .file-info { position: absolute; bottom: calc(100% + 5px); left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 6px; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .file-clear { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; border-radius: 50%; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }

      /* Tailwind ÂÖºÂÆπÁ±ª - ÂÆåÊï¥ÊîØÊåÅ */
      /* Èó¥Ë∑ù */
      .tw-p-1 { padding: 0.25rem; }
      .tw-p-2 { padding: 0.5rem; }
      .tw-p-3 { padding: 0.75rem; }
      .tw-p-4 { padding: 1rem; }
      .tw-px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
      .tw-px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
      .tw-py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
      .tw-py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
      .tw-m-1 { margin: 0.25rem; }
      .tw-m-2 { margin: 0.5rem; }
      .tw-m-3 { margin: 0.75rem; }
      .tw-m-4 { margin: 1rem; }
      .tw-mx-2 { margin-left: 0.5rem; margin-right: 0.5rem; }
      .tw-my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
      .tw-my-1 { margin-top: 0.25rem; margin-bottom: 0.25rem; }

      /* ËÉåÊôØËâ≤ */
      .tw-bg-gray-50 { background-color: #f9fafb; }
      .tw-bg-gray-100 { background-color: #f3f4f6; }
      .tw-bg-gray-200 { background-color: #e5e7eb; }
      .tw-bg-blue-50 { background-color: #eff6ff; }
      .tw-bg-blue-100 { background-color: #dbeafe; }
      .tw-bg-blue-500 { background-color: #3b82f6; }
      .tw-bg-red-50 { background-color: #fef2f2; }
      .tw-bg-red-100 { background-color: #fecaca; }
      .tw-bg-red-500 { background-color: #ef4444; }
      .tw-bg-green-50 { background-color: #f0fdf4; }
      .tw-bg-green-100 { background-color: #dcfce7; }
      .tw-bg-green-500 { background-color: #22c55e; }
      .tw-bg-yellow-50 { background-color: #fefce8; }
      .tw-bg-yellow-100 { background-color: #fef3c7; }
      .tw-bg-yellow-200 { background-color: #fde68a; }
      .tw-bg-yellow-500 { background-color: #eab308; }

      /* ÊñáÂ≠óÈ¢úËâ≤ */
      .tw-text-gray-500 { color: #6b7280; }
      .tw-text-gray-600 { color: #4b5563; }
      .tw-text-gray-700 { color: #374151; }
      .tw-text-gray-800 { color: #1f2937; }
      .tw-text-blue-500 { color: #3b82f6; }
      .tw-text-blue-600 { color: #2563eb; }
      .tw-text-blue-800 { color: #1e40af; }
      .tw-text-red-500 { color: #ef4444; }
      .tw-text-red-600 { color: #dc2626; }
      .tw-text-red-800 { color: #991b1b; }
      .tw-text-green-500 { color: #22c55e; }
      .tw-text-green-600 { color: #16a34a; }
      .tw-text-green-800 { color: #166534; }
      .tw-text-yellow-600 { color: #ca8a04; }
      .tw-text-yellow-800 { color: #92400e; }

      /* ËæπÊ°Ü */
      .tw-border { border-width: 1px; }
      .tw-border-2 { border-width: 2px; }
      .tw-border-gray-200 { border-color: #e5e7eb; }
      .tw-border-gray-300 { border-color: #d1d5db; }
      .tw-border-blue-500 { border-color: #3b82f6; }
      .tw-border-red-500 { border-color: #ef4444; }
      .tw-border-yellow-500 { border-color: #eab308; }
      .tw-border-green-500 { border-color: #22c55e; }
      .tw-border-l-4 { border-left-width: 4px; }
      .tw-border-l-8 { border-left-width: 8px; }

      /* ÂúÜËßí */
      .tw-rounded { border-radius: 0.25rem; }
      .tw-rounded-md { border-radius: 0.375rem; }
      .tw-rounded-lg { border-radius: 0.5rem; }
      .tw-rounded-xl { border-radius: 0.75rem; }
      .tw-rounded-full { border-radius: 9999px; }

      /* Â≠ó‰Ωì */
      .tw-font-normal { font-weight: 400; }
      .tw-font-medium { font-weight: 500; }
      .tw-font-semibold { font-weight: 600; }
      .tw-font-bold { font-weight: 700; }
      .tw-text-xs { font-size: 0.75rem; line-height: 1rem; }
      .tw-text-sm { font-size: 0.875rem; line-height: 1.25rem; }
      .tw-text-base { font-size: 1rem; line-height: 1.5rem; }
      .tw-text-lg { font-size: 1.125rem; line-height: 1.75rem; }

      /* Â∏ÉÂ±Ä */
      .tw-flex { display: flex; }
      .tw-inline-flex { display: inline-flex; }
      .tw-block { display: block; }
      .tw-inline-block { display: inline-block; }
      .tw-hidden { display: none; }
      .tw-flex-row { flex-direction: row; }
      .tw-flex-col { flex-direction: column; }
      .tw-items-center { align-items: center; }
      .tw-items-start { align-items: flex-start; }
      .tw-justify-center { justify-content: center; }
      .tw-justify-between { justify-content: space-between; }
      .tw-gap-1 { gap: 0.25rem; }
      .tw-gap-2 { gap: 0.5rem; }
      .tw-gap-4 { gap: 1rem; }

      /* Èò¥ÂΩ± */
      .tw-shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
      .tw-shadow-md { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
      .tw-shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }

      /* ÁâπÊÆäÊ†∑Âºè */
      .tw-opacity-50 { opacity: 0.5; }
      .tw-opacity-75 { opacity: 0.75; }
      .tw-cursor-pointer { cursor: pointer; }
      .tw-select-none { user-select: none; }

      /* Mark ÂÖÉÁ¥†Ê†∑Âºè‰øÆÂ§ç */
      mark { background-color: inherit; color: inherit; padding: 0; }
      .tw-bg-yellow-200 mark, mark.tw-bg-yellow-200 { background-color: #fde68a !important; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
       .btn { padding:7px 9px; border-radius:9px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
       .btn:hover { background:#f9fafb; }
       .system-btn { padding:3px 8px; border-radius:7px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-size:12px; color:#374151; }
       .system-btn:hover { background:#f3f4f6; }
      .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:2147483500; }
      .modal-card { width:360px; background:#fff; border-radius:12px; box-shadow:0 20px 45px rgba(0,0,0,0.18); padding:16px; display:flex; flex-direction:column; gap:12px; }
       .modal-card h3 { margin:0; font-size:17px; font-weight:600; color:#111827; }
       .modal-card p { margin:0; font-size:13px; color:#4b5563; }
      .modal-card textarea { min-height:120px; resize:vertical; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db; font-size:13px; }
      .modal-actions { display:flex; justify-content:flex-end; gap:8px; }
      .modal-btn { padding:6px 12px; border-radius:8px; border:1px solid transparent; cursor:pointer; font-size:13px; }
      .modal-btn.save { background:#2563eb; color:#fff; border-color:#1d4ed8; }
      .modal-btn.save:hover { background:#1d4ed8; }
      .modal-btn.cancel { background:#f3f4f6; color:#374151; border-color:#d1d5db; }
      .modal-btn.cancel:hover { background:#e5e7eb; }
    `;

    const wrap = document.createElement('div');
    wrap.className = 'wrap';
    wrap.innerHTML = `
      <div class="app">
        <div class="card sidebar">
          <div class="side-head">
            <div style="font-weight:600;">ÂØπËØù</div>
            <button class="btn" id="newChat">Êñ∞Âª∫</button>
          </div>
          <div class="search"><input id="q" placeholder="ÊêúÁ¥¢‰ºöËØù‚Ä¶" /></div>
          <div class="list" id="list"></div>
        </div>
        <div class="card main">
          <div class="head">
            <div class="title" id="title">ËØ∑ÈÄâÊã©‰ºöËØù</div>
            <div class="model-selector">
              <button class="system-btn" id="systemPromptBtn" title="ËÆæÁΩÆÁ≥ªÁªüÊèêÁ§∫ËØç">Á≥ªÁªüÊèêÁ§∫ËØç</button>
              <label for="modelSelect">Ê®°Âûã:</label>
              <select id="modelSelect">
                <option value="gpt-5">GPT-5</option>
                <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                <option value="claude-opus-4-20250514">Claude Opus 4</option>
                <option value="claude-sonnet-4-20250514" selected>Claude Sonnet 4</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="deepseek-v3.1">DeepSeek V3.1</option>
              </select>
            </div>

          </div>
          <div class="msgs" id="msgs"></div>
          <div class="foot">
            <div class="input">
              <div class="upload-btn" id="uploadBtn" title="‰∏ä‰º†Êñá‰ª∂">
                üìÅ
                <input type="file" class="file-input" id="fileInput" accept=".txt,.md,.py,.js,.ts,.html,.css,.json,text/*">
                <div class="file-info" id="fileInfo" style="display: none;"></div>
                <div class="file-clear" id="fileClear" style="display: none;">√ó</div>
              </div>
              <textarea id="input" placeholder="Shift+Enter Êç¢Ë°åÔºõEnter ÂèëÈÄÅ / ÁîüÊàê‰∏≠Êåâ Enter ÂÅúÊ≠¢"></textarea>
              <button class="send" id="send">ÂèëÈÄÅ</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // ÂàõÂª∫ËÉåÊôØÊ®°Á≥äÂ±Ç
    const backdrop = document.createElement('div');
    backdrop.className = 'backdrop';

    // ÁÇπÂáªËÉåÊôØ‰∏çÂÖ≥Èó≠Èù¢ÊùøÔºå‰øùÊåÅÊâìÂºÄÁä∂ÊÄÅ
    // backdrop.onclick = () => toggleUI(false);

    root.shadowRoot.append(style, backdrop, wrap);
    document.documentElement.appendChild(root);

    // Ê≥®ÂÖ•ÂØºËà™Ê†èÊåâÈíÆ
    injectNavButton();

    // refs
    const $ = sel => root.shadowRoot.querySelector(sel);
    $sidebar = $('#list'); $messages = $('#msgs'); $input = $('#input'); $send = $('#send'); $usage = $('#usage'); $title = $('#title');
    const $modelSelect = $('#modelSelect');
    const $systemPromptBtn = $('#systemPromptBtn');

    // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®
    initModelSelector($modelSelect);

    if ($systemPromptBtn) {
      updateSystemPromptButton($systemPromptBtn);
      $systemPromptBtn.addEventListener('click', () => {
        openPromptModal();
      });
    } else {
      updateSystemPromptButton();
    }

    // ÊµãËØïÊ®°ÂûãÈÄâÊã©Âô®ÂäüËÉΩ
    setTimeout(() => {
      const currentModel = getCurrentModel();
      const displayName = getModelDisplayName(currentModel);
      console.log(`[Ê®°ÂûãÈÄâÊã©Âô®] ÊµãËØï - ÂΩìÂâçÊ®°Âûã: ${displayName}`);
      console.log(`[Ê®°ÂûãÈÄâÊã©Âô®] ÊµãËØï - ÈÄâÊã©Âô®ÂÄº: ${$modelSelect.value}`);
      console.log(`[ÊèêÁ§∫ËØç] ÂΩìÂâçÁ≥ªÁªüÊèêÁ§∫ËØç${customSystemPrompt ? 'Â∑≤ËÆæÁΩÆ' : '‰∏∫Á©∫'}`);
    }, 500);

     $('#newChat').onclick = () => createConversation();

    $send.onclick = onSendButtonClick;
    updateSendButtonUI();

    // Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
    const $uploadBtn = $('#uploadBtn');
    const $fileInput = $('#fileInput');
    const $fileInfo = $('#fileInfo');
    const $fileClear = $('#fileClear');

    // ÂÖ®Â±ÄÊñá‰ª∂UIÊõ¥Êñ∞ÂáΩÊï∞
    window.updateFileUI = function() {
      if (state.uploadedFile) {
        $uploadBtn.classList.add('has-file');
        $uploadBtn.title = `Â∑≤Âä†ËΩΩ: ${state.uploadedFile.name}`;
        $fileInfo.textContent = state.uploadedFile.name;
        $fileInfo.style.display = 'block';
        $fileClear.style.display = 'block';
      } else {
        $uploadBtn.classList.remove('has-file');
        $uploadBtn.title = '‰∏ä‰º†Êñá‰ª∂';
        $fileInfo.style.display = 'none';
        $fileClear.style.display = 'none';
      }
    };

    $uploadBtn.onclick = () => $fileInput.click();
    $fileInput.addEventListener('change', handleFileUpload);
    $fileClear.onclick = clearFile;

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        state.uploadedFile = {
          name: file.name,
          content: event.target.result
        };
        window.updateFileUI();
      };
      reader.onerror = () => {
        alert('ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºÅ');
        clearFile();
      };
      reader.readAsText(file);
    }

    function clearFile() {
      state.uploadedFile = null;
      $fileInput.value = '';
      window.updateFileUI();
    }

    function updateFileUI() {
      window.updateFileUI();
    }

    // Enter ÂèëÈÄÅ / ÂÅúÊ≠¢
    $input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        onSendButtonClick();
      }
    });

    // ‰ª£Á†ÅÂùóÂ§çÂà∂Ôºà‰∫ã‰ª∂ÂßîÊâòÔºåÂÖºÂÆπÊµÅÂºèÊèíÂÖ•Ôºâ
    $messages.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-code');
      if (!btn) return;
      const raw = decodeURIComponent(btn.getAttribute('data-raw') || '');
      try { await navigator.clipboard.writeText(raw); btn.textContent = 'Â∑≤Â§çÂà∂'; setTimeout(()=>btn.textContent='Â§çÂà∂', 1100); } catch {}
    });

    // ‰ª£Á†ÅÂùóÂ±ïÂºÄÊäòÂè†Ôºà‰∫ã‰ª∂ÂßîÊâòÔºåÂÖºÂÆπÊµÅÂºèÊèíÂÖ•Ôºâ
    $messages.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle-code');
      if (!btn) return;

      console.log('[ÊäòÂè†ÂäüËÉΩ] ÁÇπÂáª‰∫ÜÊäòÂè†ÊåâÈíÆ', btn);
      const codeWrap = btn.closest('.code-wrap');
      if (!codeWrap) {
        console.log('[ÊäòÂè†ÂäüËÉΩ] Êâæ‰∏çÂà∞code-wrap');
        return;
      }

      const codeBlock = codeWrap.querySelector('.code-block');
      if (!codeBlock) {
        console.log('[ÊäòÂè†ÂäüËÉΩ] Êâæ‰∏çÂà∞code-block');
        return;
      }

      if (codeBlock.classList.contains('collapsed')) {
        codeBlock.classList.remove('collapsed');
        btn.textContent = 'ÊäòÂè†';
        console.log('[ÊäòÂè†ÂäüËÉΩ] Â±ïÂºÄ‰ª£Á†ÅÂùó');
      } else {
        codeBlock.classList.add('collapsed');
        btn.textContent = 'Â±ïÂºÄ';
        console.log('[ÊäòÂè†ÂäüËÉΩ] ÊäòÂè†‰ª£Á†ÅÂùó');
      }
    });

    // ÂàùÂßãÂåñÊô∫ËÉΩÊªöÂä®Ë∑üË∏™
    initScrollTracking();
  }
  // Ê≥®ÂÖ•ÂØºËà™Ê†èÊåâÈíÆ
  function injectNavButton() {
    // Á≠âÂæÖÁΩëÁ´ôÂØºËà™Ê†èÂä†ËΩΩ
    const waitForNav = setInterval(() => {
      const navContainer = document.querySelector('nav.hidden.lg\\:flex');
      if (navContainer) {
        clearInterval(waitForNav);

        // ÂàõÂª∫ËÅäÂ§©Èù¢ÊùøÊåâÈíÆ
        const chatButton = document.createElement('a');
        chatButton.className = 'relative px-3 py-2 text-sm font-medium transition-colors rounded-sm outline-none focus-visible:ring-2 focus-visible:ring-foreground focus-visible:ring-offset-2 text-muted-foreground hover:text-foreground cursor-pointer';
        chatButton.textContent = 'ÂØπËØùÈù¢Êùø';
        chatButton.onclick = (e) => {
          e.preventDefault();
          toggleUI();
        };

        // ÊèíÂÖ•Âà∞"Â≠¶‰π†"ÂêéÈù¢
        navContainer.appendChild(chatButton);

        console.log('[ÂØºËà™ÈõÜÊàê] ËÅäÂ§©Èù¢ÊùøÊåâÈíÆÂ∑≤Ê∑ªÂä†Âà∞ÂØºËà™Ê†è');
      }
    }, 100);

    // 10ÁßíÂêéÂÅúÊ≠¢Â∞ùËØï
    setTimeout(() => clearInterval(waitForNav), 10000);
  }

  function toggleUI(force) {
    if (!root) return;
    const wrap = root.shadowRoot.querySelector('.wrap');
    const backdrop = root.shadowRoot.querySelector('.backdrop');

    const isVisible = typeof force === 'boolean' ? force : (wrap.style.display !== 'block');

    if (isVisible) {
      wrap.style.display = 'block';
      backdrop.style.display = 'block';
      console.log('[ÂØºËà™ÈõÜÊàê] ËÅäÂ§©Èù¢ÊùøÂ∑≤ÊâìÂºÄ');
    } else {
      wrap.style.display = 'none';
      backdrop.style.display = 'none';
      console.log('[ÂØºËà™ÈõÜÊàê] ËÅäÂ§©Èù¢ÊùøÂ∑≤ÂÖ≥Èó≠');
    }
  }
  document.addEventListener('keydown', (e) => {
    // ESCÈîÆÂÖ≥Èó≠Èù¢Êùø
    if (e.key === 'Escape') {
      const wrap = root?.shadowRoot?.querySelector('.wrap');
      if (wrap && wrap.style.display === 'block') {
        toggleUI(false);
        e.preventDefault();
      }
    }
    // ÂéüÊúâÂø´Êç∑ÈîÆ
    if (!!e.ctrlKey === !!UI_HOTKEY.ctrlKey && !!e.altKey === !!UI_HOTKEY.altKey && e.key.toLowerCase() === UI_HOTKEY.key) {
      toggleUI();
    }
  });

  /** ========= Ê∏≤Êüì ========= **/
  function renderSidebar(filter='') {
    if (!$sidebar) return;
    const items = Object.values(state.conversations).sort((a,b)=> (b.updatedAt||'').localeCompare(a.updatedAt||''));
    $sidebar.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const c of items) {
      if (filter && !((c.title||'')+JSON.stringify(c.messages)).includes(filter)) continue;
      const div = document.createElement('div');
      div.className = 'item' + (state.activeId === c.id ? ' active' : '');

      // ‰ΩøÁî®innerHTMLÊù•ÊòæÁ§∫Ê†áÈ¢òÂíåÊó•Êúü
      const title = c.title || 'Êú™ÂëΩÂêç';
      const safeTitle = escHtml(title);
      const date = formatDate(c.createdAt || c.updatedAt);
      const safeDate = escHtml(date);
      div.innerHTML = `
        <div class="item-main">
          <span class="item-title">${safeTitle}</span>
          <span class="item-icons">
            <button class="item-icon rename" title="ÈáçÂëΩÂêç" aria-label="ÈáçÂëΩÂêç">‚úèÔ∏è</button>
            <button class="item-icon delete" title="Âà†Èô§" aria-label="Âà†Èô§">üóëÔ∏è</button>
          </span>
        </div>
        <div class="item-date">${safeDate}</div>
      `;

      div.onclick = () => {
        state.activeId = c.id;
        // ÂàáÊç¢ÂØπËØùÊó∂ÈáçÁΩÆÊªöÂä®Áä∂ÊÄÅÔºåÈÅøÂÖçÈó™Áé∞
        userScrolledAway = false;
        saveStore(); renderSidebar(); renderMessages(); renderHeader();
        updateSendButtonUI(); // ÂàáÊç¢‰ºöËØùÊó∂Êõ¥Êñ∞ÊåâÈíÆ

        console.log(`[‰ºöËØùÂàáÊç¢] ÂàáÊç¢Âà∞‰ºöËØù: ${c.id}`);
      };
      const renameBtn = div.querySelector('.item-icon.rename');
      const deleteBtn = div.querySelector('.item-icon.delete');
      if (renameBtn) {
        renameBtn.onclick = (evt) => {
          evt.stopPropagation();
          startInlineRename(div, c);
        };
      }
      if (deleteBtn) {
        deleteBtn.onclick = (evt) => {
          evt.stopPropagation();
          handleItemDelete(div, c.id, deleteBtn);
        };
      }
      frag.appendChild(div);
    }
    $sidebar.appendChild(frag);
    const $q = root.shadowRoot.querySelector('#q');
    if ($q && !$q._bound) {
      $q._bound = true;
      $q.addEventListener('input', () => renderSidebar($q.value.trim()));
    }
    updateSystemPromptButton();
  }
  function renderHeader() {
    const c = state.conversations[state.activeId || ''] || null;
    if ($title) $title.textContent = c ? (c.title || 'Êú™ÂëΩÂêç') : 'ËØ∑ÈÄâÊã©‰ºöËØù';
  }
  function scrollToBottom() {
    if (!$messages) return;

    // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Êé•ËøëÂ∫ïÈÉ®ÔºàÂÆπÂøç50pxÁöÑËØØÂ∑ÆÔºâ
    const isNearBottom = $messages.scrollTop + $messages.clientHeight >= $messages.scrollHeight - 50;

    // Âè™ÊúâÂú®Áî®Êà∑Êé•ËøëÂ∫ïÈÉ®Êó∂ÊâçËá™Âä®ÊªöÂä®
    if (isNearBottom) {
      $messages.scrollTop = $messages.scrollHeight + 9999;
    }
  }

  // Ê∑ªÂä†Áî®Êà∑ÊªöÂä®Áä∂ÊÄÅË∑üË∏™
  let userScrolledAway = false;

  function initScrollTracking() {
    if (!$messages) return;

    $messages.addEventListener('scroll', () => {
      const isNearBottom = $messages.scrollTop + $messages.clientHeight >= $messages.scrollHeight - 50;
      userScrolledAway = !isNearBottom;
    });
  }

  // Êô∫ËÉΩÊªöÂä®ÂáΩÊï∞ - Âè™Âú®Áî®Êà∑Ê≤°ÊúâÊâãÂä®‰∏äÊªëÊó∂ÊªöÂä®Ôºå‰ºòÂåñÊó†Èó™Áé∞ÊªöÂä®
  function smartScrollToBottom() {
    if (!$messages || userScrolledAway) return;
    // ‰ΩøÁî® requestAnimationFrame Êõø‰ª£ setTimeout ÂáèÂ∞ëÈó™Áé∞
    requestAnimationFrame(() => {
      if (!userScrolledAway) {
        $messages.scrollTop = $messages.scrollHeight;
      }
    });
  }

  function renderMessages() {
    if (!$messages) return;
    $messages.innerHTML = '';
    const c = state.conversations[state.activeId || ''];
    if (!c) return;

    c.messages.forEach((m, idx) => {
      const d = document.createElement('div');
      d.className = 'bubble ' + (m.role === 'user' ? 'user' : 'assistant');
      const status = m.status === 'stopped' ? `<span class="status">Â∑≤‰∏≠Êñ≠</span>` : '';
      // ÊòæÁ§∫Ê®°ÂûãÂêçÁß∞ËÄå‰∏çÊòØ "assistant"
      const roleDisplay = m.role === 'assistant' ? (getModelShortName(m.model) || 'Assistant') : m.role;
      d.innerHTML = `
        <div class="content">${renderMD(m.content)}</div>
        <div class="meta">
          <span>${roleDisplay} ¬∑ ${new Date(m.ts||nowISO()).toLocaleTimeString()} ${status}</span>
          <div class="tools">
            <span class="tool copy">Â§çÂà∂</span>
            <span class="tool del">Âà†Èô§</span>
            ${m.role === 'assistant' ? `<span class="tool regen">ÈáçÊñ∞ÁîüÊàê</span>${m.status==='stopped'?`<span class="tool resume">ÁªßÁª≠</span>`:''}` : ''}
            ${m.role === 'user' ? `<span class="tool resend">ÈáçÂèë</span>` : ''}
          </div>
        </div>`;

      // Â∑•ÂÖ∑
      d.querySelector('.tool.copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(m.content||''); }catch{} };
      d.querySelector('.tool.del').onclick  = ()=>{ c.messages.splice(idx,1); c.updatedAt=nowISO(); saveStore(); renderMessages(); renderSidebar(); };
      const regen = d.querySelector('.tool.regen');
      const resend = d.querySelector('.tool.resend');
      const resume = d.querySelector('.tool.resume');
      if (regen)  regen.onclick  = ()=> regenerateAssistantAt(idx);
      if (resend) resend.onclick = ()=> resendUserAt(idx);
      if (resume) resume.onclick = ()=> resumeAssistantAt(idx);

      $messages.appendChild(d);

      // ÂØπÂä©ÊâãÊ∂àÊÅØÂ∫îÁî®Âä®ÊÄÅÊäòÂè†Ê£ÄÊµã
      if (m.role === 'assistant') {
        setTimeout(() => dynamicCodeBlockCollapse(d), 10);
      }
    });
    smartScrollToBottom();
  }

  /** ========= ËæìÂÖ•/ÂèëÈÄÅ/ÂÅúÊ≠¢ÔºàÊØè‰ºöËØùÁã¨Á´ãÔºâ ========= **/
  async function onSendButtonClick() {
    const convId = state.activeId; if (!convId) return;
    const rt = getRT(convId);

    if (rt.isGenerating) {
      console.log(`[‰ºöËØùÈöîÁ¶ª] ÂÅúÊ≠¢‰ºöËØù ${convId} ÁöÑÁîüÊàê`);
      // ÂÅúÊ≠¢ËØ∑Ê±Ç
      if (rt.controller) { try { rt.controller.abort(); } catch {} }
      // ÁªàÊ≠¢ÈÉ®ÂàÜÂÜÖÂÆπ‰∏∫ÂÅúÊ≠¢Áä∂ÊÄÅ
      finalizePartialAsStopped(convId);
      // Ê∏ÖÁêÜÁõëÂê¨Âô®
      cleanupListenerForConv(convId);
      // ÈáçÁΩÆÁä∂ÊÄÅ
      rt.isGenerating = false;
      rt.controller = null;
      updateSendButtonUI();
      return;
    }
    await sendCurrent();
  }
  function updateSendButtonUI() {
    const convId = state.activeId; if (!convId || !$send) return;
    const rt = getRT(convId);
    if (rt.isGenerating) { $send.textContent = 'ÂÅúÊ≠¢'; $send.title = 'Ê≠£Âú®ÁîüÊàêÔºåÁÇπÂáªÂÅúÊ≠¢'; }
    else { $send.textContent = 'ÂèëÈÄÅ'; $send.title = 'ÂèëÈÄÅÊ∂àÊÅØ'; }
  }

  async function sendCurrent() {
    const convId = state.activeId; if (!convId) { createConversation(); return; }

    console.log(`[Âπ∂Ë°åÂØπËØù] ÂºÄÂßã‰ºöËØù ${convId} ÁöÑÊñ∞ËØ∑Ê±Ç`);

    const c = state.conversations[convId];
    const text = ($input.value || '').trim(); if (!text) return;
    $input.value = '';

    // Áî®Êà∑Ê∂àÊÅØ
    const uMsg = { id: uid('m'), role:'user', content:text, ts: nowISO() };
    c.messages.push(uMsg);
    c.updatedAt = nowISO();
    if (!c.title || c.title === 'Êñ∞ÂØπËØù' || c.title === 'Êú™ÂëΩÂêç') c.title = text.slice(0, 20) || 'Êú™ÂëΩÂêç';
    saveStore(); renderSidebar(); renderMessages(); renderHeader();

    // ÂéÜÂè≤ÔºàOpenAI ÂΩ¢ÊÄÅÔºâ
    let history = c.messages.map(m => ({ role: m.role, content: m.content }));
    history = ensureGlobalSystem(history);
    if (INJECT_TO_FIRST_USER_TOO) history = injectToFirstUser(history);

    // runtime
    const rt = getRT(convId);
    rt.curAssistant = { node:null, content:'', targetIndex:null };

    // ÁõëÂê¨Âô®
    const l = buildListenerForStreaming(convId, c, null);
    bridge.listeners.add(l); bridge.order.push(l);
    rt.listener = l; rt.isGenerating = true; updateSendButtonUI();

    // Ê≥®ÂÖ• & Ëß¶Âèë
    window.__upstreamMessages = history;
    ensureAssistantBubble(convId);

    if (FAST_SEND) {
      const { controller } = await sendViaDirectFetch(convId, l.expectedRid);
      rt.controller = controller;
    } else {
      await submitMessageViaUI(text, { ifGenerating:'none' });
    }
  }

  function finalizePartialAsStopped(convId) {
    const c = state.conversations[convId||'']; if (!c) return;
    const rt = getRT(convId);
    const cur = rt.curAssistant;

    if (cur && (cur.content||'').trim()) {
      if (cur.targetIndex != null) {
        const t = c.messages[cur.targetIndex];
        if (t && t.role === 'assistant') { t.content = cur.content; t.status = 'stopped'; t.ts = nowISO(); }
      } else {
        c.messages.push({ id: uid('m'), role:'assistant', content: cur.content, ts: nowISO(), status:'stopped', model: getCurrentModel() });
      }
      c.updatedAt = nowISO();
      saveStore(); renderMessages();
    }
    rt.curAssistant = { node:null, content:'', targetIndex:null };
  }

  async function regenerateAssistantAt(index) {
    const convId = state.activeId; if (!convId) return;
    const c = state.conversations[convId||'']; if (!c) return;
    const rt = getRT(convId);
    if (rt.isGenerating) { alert('ÂΩìÂâç‰ºöËØùÊ≠£Âú®ÁîüÊàêÔºåËØ∑ÂÖàÂÅúÊ≠¢ÊàñÁ≠âÂæÖÁªìÊùü'); return; }
    const m = c.messages[index]; if (!m || m.role !== 'assistant') return;

    // ÊâæÂà∞ËØ•Âä©Êâã‰πãÂâçÊúÄËøë user
    let uIdx = -1;
    for (let i=index-1; i>=0; i--) { if (c.messages[i].role === 'user') { uIdx = i; break; } }
    if (uIdx === -1) { alert('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàê'); return; }

    // ÂéÜÂè≤Âà∞ËØ• userÔºàÂê´Ôºâ
    let history = c.messages.slice(0, uIdx+1).map(x => ({ role:x.role, content:x.content }));
    history = ensureGlobalSystem(history);
    if (INJECT_TO_FIRST_USER_TOO) history = injectToFirstUser(history);

    // ÊõøÊç¢Ê®°ÂºèÁõëÂê¨
    const l = buildListenerForStreaming(convId, c, index);
    bridge.listeners.add(l); bridge.order.push(l);
    rt.listener = l; rt.isGenerating = true; updateSendButtonUI();

    c.messages[index].content = '';
    c.messages[index].status = undefined;
    saveStore(); renderMessages();

    window.__upstreamMessages = history;
    rt.curAssistant = { node:null, content:'', targetIndex:index };

    if (FAST_SEND) {
      const { controller } = await sendViaDirectFetch(convId, l.expectedRid);
      rt.controller = controller;
    } else {
      await submitMessageViaUI(c.messages[uIdx].content, { ifGenerating:'none' });
    }
  }

  async function resumeAssistantAt(index) {
    const convId = state.activeId; if (!convId) return;
    const c = state.conversations[convId||'']; if (!c) return;
    const rt = getRT(convId);
    if (rt.isGenerating) { alert('ÂΩìÂâç‰ºöËØùÊ≠£Âú®ÁîüÊàêÔºåËØ∑ÂÖàÂÅúÊ≠¢ÊàñÁ≠âÂæÖÁªìÊùü'); return; }
    const m = c.messages[index]; if (!m || m.role !== 'assistant') return;

    const CONTINUE_HINT = 'ËØ∑‰ªé‰∏äÊ¨°‰∏≠Êñ≠Â§ÑÁªßÁª≠ËæìÂá∫ÔºåÂª∂Áª≠Áõ∏ÂêåÈ£éÊ†º‰∏éÁªìÊûÑÔºå‰∏çË¶ÅÈáçÂ§çÂ∑≤ÁªôÂá∫ÁöÑÈÉ®ÂàÜ„ÄÇ';
    let history = c.messages.map(x => ({ role:x.role, content:x.content }));
    history = ensureGlobalSystem(history);
    history.push({ role:'system', content: CONTINUE_HINT });

    const l = buildListenerForStreaming(convId, c, null);
    bridge.listeners.add(l); bridge.order.push(l);
    rt.listener = l; rt.isGenerating = true; updateSendButtonUI();

    window.__upstreamMessages = history;
    rt.curAssistant = { node:null, content:'', targetIndex:null };
    ensureAssistantBubble(convId);

    if (FAST_SEND) {
      const { controller } = await sendViaDirectFetch(convId, l.expectedRid);
      rt.controller = controller;
    } else {
      await submitMessageViaUI('ÔºàÁªßÁª≠Ôºâ', { ifGenerating:'none' });
    }
  }

  async function resendUserAt(index) {
    const convId = state.activeId; if (!convId) return;
    const c = state.conversations[convId||'']; if (!c) return;
    const rt = getRT(convId);
    if (rt.isGenerating) { alert('ÂΩìÂâç‰ºöËØùÊ≠£Âú®ÁîüÊàêÔºåËØ∑ÂÖàÂÅúÊ≠¢ÊàñÁ≠âÂæÖÁªìÊùü'); return; }
    const m = c.messages[index]; if (!m || m.role !== 'user') return;

    c.messages = c.messages.slice(0, index+1);
    saveStore(); renderMessages();

    let history = c.messages.map(x => ({ role:x.role, content:x.content }));
    history = ensureGlobalSystem(history);
    if (INJECT_TO_FIRST_USER_TOO) history = injectToFirstUser(history);

    const l = buildListenerForStreaming(convId, c, null);
    bridge.listeners.add(l); bridge.order.push(l);
    rt.listener = l; rt.isGenerating = true; updateSendButtonUI();

    window.__upstreamMessages = history;
    rt.curAssistant = { node:null, content:'', targetIndex:null };
    ensureAssistantBubble(convId);

    if (FAST_SEND) {
      const { controller } = await sendViaDirectFetch(convId, l.expectedRid);
      rt.controller = controller;
    } else {
      await submitMessageViaUI(m.content, { ifGenerating:'none' });
    }
  }

  /** ========= Á´ôÁÇπÊåâÈíÆÔºà‰ªÖ UI Ë∑ØÂæÑÂÖúÂ∫ïÁî®Ôºâ ========= **/
  async function findChatInput(timeout = 6000) {
    let el = null;
    for (let i = 0; i < timeout/80; i++) {
      el = document.querySelector('textarea[aria-label="Chat message"]') ||
           document.querySelector('div[contenteditable="true"][data-placeholder]') ||
           document.querySelector('div[contenteditable="true"]');
      if (el) break;
      await new Promise(r => setTimeout(r, 80));
    }
    return el;
  }
  function setNativeValue(el, value) {
    const proto = el.__proto__ || Object.getPrototypeOf(el);
    const desc = Object.getOwnPropertyDescriptor(proto, 'value');
    const setter = desc && desc.set;
    const defaultSetter = (el.tagName === 'TEXTAREA'
      ? Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value')
      : Object.getPropertyDescriptor?.(HTMLInputElement.prototype, 'value')?.set
    );
    (setter || defaultSetter)?.call(el, value);
  }
  async function submitMessageViaUI(userText, { timeoutMs = 6000 } = {}) {
    const inputEl = await findChatInput(timeoutMs);
    if (!inputEl) throw new Error('Êú™ÊâæÂà∞ËÅäÂ§©ËæìÂÖ•Ê°Ü');
    inputEl.focus();
    if (inputEl.tagName === 'TEXTAREA' || inputEl instanceof HTMLTextAreaElement) setNativeValue(inputEl, userText||'');
    else if (inputEl.isContentEditable) { inputEl.innerHTML=''; inputEl.appendChild(document.createTextNode(userText||'')); }
    else setNativeValue(inputEl, userText||'');
    inputEl.dispatchEvent(new Event('input', { bubbles:true }));
    inputEl.dispatchEvent(new Event('change',{ bubbles:true }));

    const btnSel = 'button[type="submit"][data-slot="button"], button[type="submit"]';
    let btn = document.querySelector(btnSel);
    if (btn && !btn.disabled) { try { btn.click(); return; } catch{} }
    try {
      const kd = new KeyboardEvent('keydown', { key:'Enter', code:'Enter', which:13, keyCode:13, bubbles:true });
      const ku = new KeyboardEvent('keyup',   { key:'Enter', code:'Enter', which:13, keyCode:13, bubbles:true });
      inputEl.dispatchEvent(kd); inputEl.dispatchEvent(ku);
    } catch {}
  }

  /** ========= fetch Êã¶Êà™ÔºöÊûÑÈÄ† Cursor ‰Ωì + SSE Êåâ rid ÂàÜÂèë ========= **/
  const prevFetch = window.fetch.bind(window);
  const bridge = { listeners: new Set(), order: [] };
  window.emitMeta  = (meta) => {
    const rid = meta?.rid; if (!rid) return;
    console.log(`[Âπ∂Ë°åÂØπËØù] Êî∂Âà∞ÂÖÉÊï∞ÊçÆÔºårid=${rid}`);

    // ‰ºòÂÖàÊü•ÊâæÈ¢ÑÊúüridÂåπÈÖçÁöÑÁõëÂê¨Âô®
    for (const l of bridge.listeners) {
      if (l.expectedRid === rid && !l.rid) {
        l.rid = rid;
        l.active = true;
        console.log(`[Âπ∂Ë°åÂØπËØù] ÂåπÈÖçÁõëÂê¨Âô®Ôºå‰ºöËØù=${l.convId}, rid=${rid}`);
        return;
      }
    }

    // ÂõûÈÄÄÂà∞ÂéüÊù•ÁöÑÈÄªËæëÔºà‰ªéÂêéÂæÄÂâçÊâæÔºâ
    for (let i=bridge.order.length-1;i>=0;i--){
      const l=bridge.order[i];
      if (!l.rid){
        l.rid=rid;
        l.active=true;
        console.log(`[Âπ∂Ë°åÂØπËØù] ÂõûÈÄÄÂåπÈÖçÁõëÂê¨Âô®Ôºå‰ºöËØù=${l.convId}, rid=${rid}`);
        break;
      }
    }
  };
  window.emitDelta = (rid, d) => {
    for (const l of bridge.listeners) if (l.active && l.rid === rid) { try { l.onDelta && l.onDelta(d); } catch{} }
  };
  window.emitDone  = (rid) => {
    for (const l of bridge.order) if (l.rid === rid && l.active) { try { l.onDone && l.onDone(); } catch{} l.active=false; break; }
  };
  window.emitUsage = (rid, u) => {
    for (const l of bridge.listeners) if (l.active && l.rid === rid) { try { l.onUsage && l.onUsage(u); } catch{} }
  };

  const ridPrefix = 'RID_' + Math.random().toString(16).slice(2) + '_'; let ridSeq=0;

  function toCursorMessages(listOpenAI) {
    return (listOpenAI || []).map(m => ({
      role: m.role,
      parts: [{ type: 'text', text: String(m.content ?? '') }],
    }));
  }
  function buildCursorBody({ messagesOpenAI, model, rid }) {
    const selectedModel = model || getCurrentModel();
    return {
      context: [],
      model: selectedModel,
      id: rid || ('req_' + Math.random().toString(16).slice(2)),
      messages: toCursorMessages(messagesOpenAI),
      trigger: 'submit-message',
      __mergedUpstream: true,
      __rid: rid,
    };
  }

  async function readBodyAsText(input, init) {
    if (input && typeof input === 'object' && input instanceof Request) {
      try { return await input.clone().text(); } catch { return null; }
    }
    const body = init && init.body;
    if (body == null) return null;
    if (typeof body === 'string') return body;
    if (body instanceof Blob) { try { return await body.text(); } catch { return null; } }
    if (body instanceof URLSearchParams) return body.toString();
    if (body instanceof FormData) return null;
    if (body instanceof ArrayBuffer) { try { return new TextDecoder().decode(body); } catch { return null; } }
    if (ArrayBuffer.isView(body)) { try { return new TextDecoder().decode(body.buffer); } catch { return null; } }
    return null;
  }
  function rebuildArgsWithBody(input, init, jsonStr) {
    const headers = new Headers((input && input.headers) || (init && init.headers) || {});
    headers.set('content-type', 'application/json; charset=utf-8');
    if (input instanceof Request) {
      const url = input.url;
      const reqInit = {
        method: (init && init.method) || input.method || 'POST',
        headers, body: jsonStr,
        mode: input.mode, credentials: input.credentials, cache: input.cache,
        redirect: input.redirect, referrer: input.referrer, referrerPolicy: input.referrerPolicy,
        integrity: input.integrity, keepalive: input.keepalive, signal: (init && init.signal) || input.signal,
      };
      return [new Request(url, reqInit), undefined];
    } else {
      const newInit = Object.assign({}, init, { headers, body: jsonStr, method: (init && init.method) || 'POST' });
      return [input, newInit];
    }
  }

  if (!prevFetch.__overlayInstalled) {
    window.fetch = async function(...args){
      let [input, init = {}] = args;
      const url = typeof input === 'string' ? input : input?.url || '';
      const method = (init?.method || (input instanceof Request ? input.method : 'GET') || 'GET').toUpperCase();
      const isChat = url.includes('/api/chat') && method === 'POST';

      let knownRid = null; // ‚òÖ ‰∏∫ËøôÊ¨°ËØ∑Ê±ÇËÆ∞‰Ωè ridÔºà‰æõ SSE Ë∑ØÁî±Ôºâ

      if (isChat) {
        try {
          const raw = await readBodyAsText(input, init);
          if (raw) {
            let body; try { body = JSON.parse(raw); } catch {}
            if (body && typeof body === 'object') {
              // Áªü‰∏ÄÂæóÂà∞ OpenAI ÂΩ¢ÊÄÅÂéÜÂè≤
              const current = Array.isArray(body.messages) ? body.messages : [];
              let msgsOpenAI = current.map(m => ({ role:m.role, content: readText(m) }));

              // Âº∫Âà∂Ë¶ÜÁõñ‰∏∫ upstream
              if (FORCE_OVERRIDE_ON_UPSTREAM && Array.isArray(window.__upstreamMessages)) {
                msgsOpenAI = window.__upstreamMessages.map(m => ({ role: m.role, content: readText(m) }));
              }

              // Ê≥®ÂÖ• system / ÂèØÈÄâÈ¶ñ user ÂâçÁºÄ
              msgsOpenAI = ensureGlobalSystem(msgsOpenAI);
              if (INJECT_TO_FIRST_USER_TOO) msgsOpenAI = injectToFirstUser(msgsOpenAI);

              // Ê≥®ÂÖ•Êñá‰ª∂ÂÜÖÂÆπÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
              if (state.uploadedFile && state.uploadedFile.content) {
                console.log(`[Êñá‰ª∂Ê≥®ÂÖ•] Ê≥®ÂÖ•Êñá‰ª∂: ${state.uploadedFile.name}`);
                const fileMessage = {
                  role: 'user',
                  content: `Êñá‰ª∂Âêç: ${state.uploadedFile.name}\n\n${state.uploadedFile.content}`
                };
                // Âú®ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂâçÊèíÂÖ•Êñá‰ª∂
                msgsOpenAI.splice(msgsOpenAI.length - 1, 0, fileMessage);
                // ÂèëÈÄÅÂêéÁ´ãÂç≥Ê∏ÖÈô§Êñá‰ª∂
                state.uploadedFile = null;
                // Êõ¥Êñ∞UI
                if (window.updateFileUI) window.updateFileUI();
              }

              // rid + metaÔºàÊó†Êù°‰ª∂ emitÔºâ
              const rid = body.__rid || (ridPrefix + (++ridSeq));
              knownRid = rid;
              try { window.emitMeta && window.emitMeta({ rid }); } catch {}

              // model - ‰ΩøÁî®Áî®Êà∑ÈÄâÊã©ÁöÑÊ®°Âûã
              const modelName = body.model || getCurrentModel();
              console.log(`[Ê®°ÂûãÈÄâÊã©] ‰ΩøÁî®Ê®°Âûã: ${modelName}`);

              // ÊûÑÈÄ† Cursor ‰Ωì
              const cursorBody = buildCursorBody({ messagesOpenAI: msgsOpenAI, model: modelName, rid });

              // ÂÜôÂõû
              const jsonStr = JSON.stringify(cursorBody);
              [input, init] = rebuildArgsWithBody(input, init, jsonStr);
            }
          }
        } catch (e){ log('rewrite failed', e); }
      }

      const resp = await prevFetch(input, init);

      if (isChat) {
        try {
          const clone = resp.clone();
          if (clone.body) (async () => {
            const reader = clone.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';

            const flush = async (chunk) => {
              const dataLines = chunk.split(/\r?\n/).filter(l => l.startsWith('data:'));
              const dataStr = dataLines.map(l => l.replace(/^data:\s?/, '')).join('\n').trim();
              if (!dataStr) return;
              if (dataStr === '[DONE]') { if (knownRid) window.emitDone(knownRid); return; }
              let evt; try { evt = JSON.parse(dataStr); } catch { return; }

              if (evt?.type === 'text-delta' && typeof evt.delta === 'string') {
                if (knownRid) window.emitDelta(knownRid, evt.delta);
              }
              const u = evt?.messageMetadata?.usage;
              if (u && knownRid) window.emitUsage(knownRid, u);
              if (evt?.type === 'text-end' || evt?.type === 'finish-step' || evt?.type === 'finish') {
                if (knownRid) window.emitDone(knownRid);
              }
            };

            while (true) {
              const { value, done } = await reader.read();
              if (done) { if (knownRid) window.emitDone(knownRid); break; }
              buf += decoder.decode(value, { stream:true });
              let idx;
              while ((idx = buf.indexOf('\n\n')) !== -1) {
                const frame = buf.slice(0, idx);
                buf = buf.slice(idx + 2);
                await flush(frame);
              }
            }
          })();
        } catch (e){ log('sse parse failed', e); }
      }
      return resp;
    };
    window.fetch.__overlayInstalled = true;
  }

  /** ========= Áõ¥ËøûÂèëÈÄÅÔºàËøîÂõû controllerÔºå‰æõ per-conv ÂÅúÊ≠¢Ôºâ ========= **/
  async function sendViaDirectFetch(convId, preAssignedRid) {
    const controller = new AbortController();
    const rid = preAssignedRid || ('RID_' + Math.random().toString(16).slice(2));
    const selectedModel = getCurrentModel();
    const body = {
      context: [],
      model: selectedModel,
      id: 'req_' + Math.random().toString(16).slice(2),
      messages: [], // ÂéÜÂè≤Áî±Êã¶Êà™Âô®Â°´
      trigger: 'submit-message',
      __mergedUpstream: true,
      __rid: rid
    };

    console.log(`[Âπ∂Ë°åÂØπËØù] ÂèëÈÄÅËØ∑Ê±ÇÔºå‰ºöËØù=${convId}, rid=${rid}, Ê®°Âûã=${selectedModel}`);

    await fetch('/api/chat', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(body),
      signal: controller.signal
    });
    return { controller, rid };
  }

  /** ========= ÂÆûÊó∂Ê∞îÊ≥°ÔºàÊåâ‰ºöËØùÁºìÂÜ≤Ôºâ ========= **/
  function ensureAssistantBubble(convId) {
    const rt = getRT(convId);
    if (rt.curAssistant.node) return;
    const d = document.createElement('div');
    d.className = 'bubble assistant';
    // ÊòæÁ§∫ÂΩìÂâçÊ®°ÂûãÂêçÁß∞ËÄå‰∏çÊòØ "assistant"
    const currentModelName = getModelShortName(getCurrentModel()) || 'Assistant';
    d.innerHTML = `<div class="content">‚Ä¶</div><div class="meta"><span>${currentModelName} ¬∑ ${new Date().toLocaleTimeString()}</span></div>`;
    $messages.appendChild(d);
    rt.curAssistant.node = d;
    smartScrollToBottom();
  }
  function redrawAssistantBubble(convId) {
    const rt = getRT(convId);
    if (!rt.curAssistant.node) return;
    rt.curAssistant.node.querySelector('.content').innerHTML = renderMD(rt.curAssistant.content || '');

    // Èò≤ÊäñÂºèÂä®ÊÄÅÊ£ÄÊµãÂíåÊõ¥Êñ∞‰ª£Á†ÅÂùóÊäòÂè†Áä∂ÊÄÅÔºàÈÅøÂÖçÈ¢ëÁπÅË∞ÉÁî®ÈÄ†ÊàêÈó™Âä®Ôºâ
    if (rt.collapseTimer) {
      clearTimeout(rt.collapseTimer);
    }
    rt.collapseTimer = setTimeout(() => {
      dynamicCodeBlockCollapse(rt.curAssistant.node);
      rt.collapseTimer = null;
    }, 100); // 100msÈò≤ÊäñÂª∂Ëøü

    smartScrollToBottom();
  }
  function redrawAssistantBubbleAt(index, text) {
    const c = state.conversations[state.activeId||'']; if (!c) return;
    c.messages[index].content = text;
    renderMessages(); // ÁÆÄÂåñÂ§ÑÁêÜÔºå‰øùÊåÅÁ¥¢ÂºïÊ≠£Á°Æ

    // Âú®ÈáçÊñ∞Ê∏≤ÊüìÂêé‰πüÊ£ÄÊü•Âä®ÊÄÅÊäòÂè†
    setTimeout(() => {
      const bubbles = $messages.querySelectorAll('.bubble.assistant');
      if (bubbles[index]) {
        dynamicCodeBlockCollapse(bubbles[index]);
      }
    }, 10);
  }

  // Âä®ÊÄÅÊ£ÄÊµã‰ª£Á†ÅÂùóÊòØÂê¶ÈúÄË¶ÅÊäòÂè†ÔºàÊµÅÂºèÊ∏≤ÊüìÊó∂‰ΩøÁî®Ôºâ
  function dynamicCodeBlockCollapse(node) {
    if (!node) return;

    const codeBlocks = node.querySelectorAll('.code-wrap');
    codeBlocks.forEach(codeWrap => {
      const codeElement = codeWrap.querySelector('.code-block code');
      const preElement = codeWrap.querySelector('.code-block');
      const headButtons = codeWrap.querySelector('.code-buttons');
      const existingToggle = headButtons?.querySelector('.toggle-code');

      if (!codeElement || !preElement) return;

      // ‰ºòÂÖà‰ΩøÁî®data-linesÂ±ûÊÄßÔºåÁÑ∂ÂêéËÆ°ÁÆóÂÆûÈôÖË°åÊï∞
      let lines = parseInt(codeWrap.getAttribute('data-lines')) || 0;

      if (!lines) {
        // ËÆ°ÁÆóÂÆûÈôÖË°åÊï∞ - ‰ΩøÁî®ÊÄªË°åÊï∞‰øùÊåÅ‰∏ÄËá¥
        let codeText = codeElement.innerHTML || codeElement.textContent || '';
        // Ëß£Á†Å HTML ÂÆû‰Ωì‰ª•Ëé∑ÂæóÂáÜÁ°ÆÁöÑË°åÊï∞
        codeText = codeText.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
        // ‰ΩøÁî®ÊÄªË°åÊï∞
        lines = codeText.split('\n').length;
        // Êõ¥Êñ∞data-linesÂ±ûÊÄß
        codeWrap.setAttribute('data-lines', lines);
      }

      const isLong = lines >= 5; // 5Ë°åÊàñ‰ª•‰∏äÂ∞±ÊäòÂè†
      const hasToggle = !!existingToggle;
      const isCollapsed = preElement.classList.contains('collapsed');

      // ËÆ∞ÂΩïÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÁä∂ÊÄÅÂèòÊõ¥Ê£ÄÊü•
      const currentState = { isLong, hasToggle, isCollapsed };
      const lastState = codeWrap._lastCollapseState || {};

      // Âè™ÊúâÂΩìÁä∂ÊÄÅÁ°ÆÂÆûÈúÄË¶ÅÊîπÂèòÊó∂ÊâçËøõË°åDOMÊìç‰ΩúÔºàÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçÁªòÔºâ
      if (JSON.stringify(currentState) === JSON.stringify(lastState)) {
        return; // Áä∂ÊÄÅÊú™ÂèòÂåñÔºåË∑≥Ëøá
      }

      codeWrap._lastCollapseState = currentState;
      console.log(`[Âä®ÊÄÅÊäòÂè†] ‰ª£Á†ÅÂùóÁä∂ÊÄÅÂèòÊõ¥: ${lines}Ë°å, ÈúÄË¶ÅÊäòÂè†=${isLong}, ÊúâÊåâÈíÆ=${hasToggle}, Â∑≤ÊäòÂè†=${isCollapsed}`);

      if (isLong && !hasToggle) {
        // ÈúÄË¶ÅÊäòÂè†‰ΩÜËøòÊ≤°ÊúâÊåâÈíÆÔºåÊ∑ªÂä†ÊäòÂè†ÊåâÈíÆÂíåÁä∂ÊÄÅ
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-code';
        toggleBtn.textContent = 'Â±ïÂºÄ';
        toggleBtn.title = 'Â±ïÂºÄ/ÊäòÂè†';
        headButtons?.appendChild(toggleBtn);

        // ËÆæÁΩÆ‰∏∫ÊäòÂè†Áä∂ÊÄÅ
        if (!isCollapsed) {
          preElement.classList.add('collapsed');
        }
      } else if (!isLong && hasToggle) {
        // ‰∏çÈúÄË¶ÅÊäòÂè†‰ΩÜÊúâÊåâÈíÆÔºåÁßªÈô§ÊåâÈíÆÂíåÊäòÂè†Áä∂ÊÄÅ
        existingToggle.remove();
        preElement.classList.remove('collapsed');
      } else if (isLong && hasToggle && !isCollapsed) {
        // Â∑≤ÁªèÊúâÊäòÂè†ÂäüËÉΩ‰ΩÜÊú™ÊäòÂè†ÔºåÁ°Æ‰øùÂ§Ñ‰∫éÊäòÂè†Áä∂ÊÄÅ
        preElement.classList.add('collapsed');
        if (existingToggle.textContent !== 'Â±ïÂºÄ') {
          existingToggle.textContent = 'Â±ïÂºÄ';
        }
      }
    });
  }

  /** ========= ÊµÅÁõëÂê¨ÔºàÂ∏¶ convIdÔºâ ========= **/
  function buildListenerForStreaming(convId, conversation, replaceIndex) {
    const rt = getRT(convId);
    // È¢ÑÂàÜÈÖç ridÔºåÁ°Æ‰øùÊØè‰∏™ÁõëÂê¨Âô®ÊúâÂîØ‰∏ÄÊ†áËØÜ
    const preAssignedRid = ridPrefix + (++ridSeq);

    const l = {
      rid: null, // ‰ªçÁÑ∂Áî± emitMeta ÊúÄÁªàÂàÜÈÖçÔºå‰ΩÜÊàë‰ª¨ËÆ∞ÂΩïÈ¢ÑÊúüÁöÑ rid
      expectedRid: preAssignedRid,
      active: false,
      closed: false,
      convId,
      onDelta: (d) => {
        if (replaceIndex != null) {
          const target = conversation.messages[replaceIndex];
          if (!target || target.role !== 'assistant') return;
          target.content = (target.content || '') + d;
          redrawAssistantBubbleAt(replaceIndex, target.content);
        } else {
          ensureAssistantBubble(convId);
          rt.curAssistant.content += d;
          redrawAssistantBubble(convId); // ÂÆûÊó∂Ê∏≤Êüì MD
        }
        $usage.textContent = 'ÁîüÊàê‰∏≠‚Ä¶';
      },
      onUsage: (u) => { $usage.textContent = `usage: in=${u?.inputTokens||0} out=${u?.outputTokens||0} total=${u?.totalTokens||0}`; },
      onDone: () => {
        if (replaceIndex != null) {
          conversation.messages[replaceIndex].status = undefined;
          conversation.messages[replaceIndex].ts = nowISO();
        } else {
          conversation.messages.push({ id: uid('m'), role:'assistant', content: rt.curAssistant.content, ts: nowISO(), model: getCurrentModel() });
          rt.curAssistant = { node:null, content:'', targetIndex:null };
        }
        conversation.updatedAt = nowISO();
        saveStore(); renderMessages();

        // Ê≠£Á°ÆÊ∏ÖÁêÜÁõëÂê¨Âô®
        cleanupListenerForConv(convId);
        rt.isGenerating = false;
        rt.controller = null;
        if (state.activeId === convId) updateSendButtonUI();

        console.log(`[Âπ∂Ë°åÂØπËØù] ‰ºöËØù ${convId} ÁîüÊàêÂÆåÊàêÔºåÊ∏ÖÁêÜÁõëÂê¨Âô®`);
      }
    };

    console.log(`[Âπ∂Ë°åÂØπËØù] ÂàõÂª∫ÁõëÂê¨Âô®Ôºå‰ºöËØù=${convId}, È¢ÑÊúürid=${preAssignedRid}`);
    return l;
  }

  /** ========= ÂêØÂä® ========= **/
  function start() {
    loadCustomPrompt();
    injectUI();
    loadStore();
    updateSystemPromptButton();
    if (!state.activeId) createConversation();
    renderSidebar(); renderMessages(); renderHeader(); updateSendButtonUI();

    // Ëá™Âä®ÊâìÂºÄËÅäÂ§©Èù¢Êùø
    setTimeout(() => {
      toggleUI(true);
      console.log('[ÂØºËà™ÈõÜÊàê] Ëá™Âä®ÊâìÂºÄËÅäÂ§©Èù¢Êùø');
    }, 1000);
  }

  // Â∞ùËØïÂ±ïÂºÄÁ´ôÁÇπ‰æßÊ†èÔºåÈÅøÂÖçÊå°‰Ωè
  setTimeout(() => {
    const candidates = [
      'button[title="Expand Chat Sidebar"]',
      'button:has(svg.lucide-panel-right-open)',
      'div.absolute.top-1\\/2.left-1\\/2.-translate-x-1\\/2.-translate-y-1\\/2.transform button[data-slot="button"][title="Expand Chat Sidebar"]',
    ];
    for (const sel of candidates) {
      const el = document.querySelector(sel);
      if (el && !el.disabled) { try { el.click(); break; } catch{} }
    }
  }, 800);

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
  else start();

  function startInlineRename(itemEl, conversation) {
    if (!itemEl || !conversation) return;
    if (itemEl.classList.contains('editing')) return;

    const titleSpan = itemEl.querySelector('.item-title');
    if (!titleSpan) return;

    itemEl.classList.add('editing');

    const input = document.createElement('input');
    input.type = 'text';
    input.value = conversation.title || 'Êú™ÂëΩÂêç';
    input.className = 'item-rename-input';
    titleSpan.replaceWith(input);
    input.focus();
    input.select();

    let finished = false;
    const finish = (commit) => {
      if (finished) return;
      finished = true;

      const originalTitle = conversation.title || 'Êú™ÂëΩÂêç';
      const nextTitle = commit ? (input.value || '').trim() : originalTitle;
      const finalTitle = nextTitle || 'Êú™ÂëΩÂêç';

      itemEl.classList.remove('editing');

      if (commit && finalTitle !== originalTitle) {
        renameConversation(conversation.id, finalTitle);
      } else {
        renderSidebar();
      }
    };

    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        finish(true);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        finish(false);
      }
    });
    input.addEventListener('blur', () => finish(true));
  }

  function resetDeleteConfirm(btn) {
    if (!btn) return;
    if (btn._confirmTimer) {
      clearTimeout(btn._confirmTimer);
      btn._confirmTimer = null;
    }
    delete btn.dataset.confirm;
    btn.classList.remove('confirm');
    btn.textContent = 'üóëÔ∏è';
    btn.title = 'Âà†Èô§';
    btn.setAttribute('aria-label', 'Âà†Èô§');
  }

  function handleItemDelete(itemEl, convId, btn) {
    if (!btn) return;
    if (btn.dataset.confirm === 'yes') {
      resetDeleteConfirm(btn);
      deleteConversation(convId);
      return;
    }

    btn.dataset.confirm = 'yes';
    btn.classList.add('confirm');
    btn.textContent = '‚úî';
    btn.title = 'Á°ÆËÆ§Âà†Èô§';
    btn.setAttribute('aria-label', 'Á°ÆËÆ§Âà†Èô§');
    btn._confirmTimer = setTimeout(() => resetDeleteConfirm(btn), 2200);
  }

  function loadCustomPrompt() {
    try {
      const stored = localStorage.getItem(CUSTOM_PROMPT_KEY);
      customSystemPrompt = stored ? String(stored) : '';
    } catch (err) {
      customSystemPrompt = '';
    }
  }

  function saveCustomPrompt(prompt) {
    customSystemPrompt = prompt || '';
    try {
      localStorage.setItem(CUSTOM_PROMPT_KEY, customSystemPrompt);
    } catch (err) {
      console.warn('[ÊèêÁ§∫ËØç] Êó†Ê≥ïÂÜôÂÖ• localStorage', err);
    }
    updateSystemPromptButton();
  }

  function getGlobalInstruction() {
    const extra = customSystemPrompt ? `${customSystemPrompt}\n` : '';
    return extra + BASE_GLOBAL_INSTRUCTION;
  }

  function updateSystemPromptButton(btn) {
    const button = btn || (root?.shadowRoot?.querySelector('#systemPromptBtn'));
    if (!button) return;
    const hasPrompt = !!customSystemPrompt;
    button.textContent = hasPrompt ? 'Á≥ªÁªüÊèêÁ§∫ËØç*' : 'Á≥ªÁªüÊèêÁ§∫ËØç';
    button.title = hasPrompt ? 'Á≥ªÁªüÊèêÁ§∫ËØçÔºàÂ∑≤ËÆæÁΩÆÔºâ' : 'ËÆæÁΩÆÁ≥ªÁªüÊèêÁ§∫ËØç';
  }

  function openPromptModal() {
    if (!root || !root.shadowRoot) return;
    const shadow = root.shadowRoot;
    const existing = shadow.querySelector('.modal-backdrop.prompt-modal');
    if (existing) existing.remove();

    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop prompt-modal';

    const card = document.createElement('div');
    card.className = 'modal-card';

    const title = document.createElement('h3');
    title.textContent = 'Á≥ªÁªüÊèêÁ§∫ËØç';

    const desc = document.createElement('p');
    desc.textContent = 'ËÆæÁΩÆÂêé‰ºöËá™Âä®ËøΩÂä†Âà∞ÈªòËÆ§Êåá‰ª§‰πãÂâçÔºåÂèØÁïôÁ©∫„ÄÇ';

    const textarea = document.createElement('textarea');
    textarea.placeholder = 'Âú®Ê≠§ËæìÂÖ•Á≥ªÁªüÊèêÁ§∫ËØçÔºàÂèØÂ§öË°åÔºå‰øùÂ≠òÂêéÁîüÊïàÔºâ';
    textarea.value = customSystemPrompt || '';

    const actions = document.createElement('div');
    actions.className = 'modal-actions';

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn cancel';
    cancelBtn.textContent = 'ÂèñÊ∂à';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'modal-btn save';
    saveBtn.textContent = '‰øùÂ≠ò';

    const close = () => {
      if (backdrop.isConnected) backdrop.remove();
    };

    cancelBtn.addEventListener('click', () => close());
    backdrop.addEventListener('click', (event) => {
      if (event.target === backdrop) close();
    });

    saveBtn.addEventListener('click', () => {
      const value = textarea.value.trim();
      saveCustomPrompt(value);
      close();
      console.log('[ÊèêÁ§∫ËØç] Â∑≤Êõ¥Êñ∞');
    });

    textarea.addEventListener('keydown', (event) => {
      if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
        event.preventDefault();
        saveBtn.click();
      }
    });

    actions.append(cancelBtn, saveBtn);
    card.append(title, desc, textarea, actions);
    backdrop.appendChild(card);
    shadow.appendChild(backdrop);

    setTimeout(() => textarea.focus(), 0);
  }

})();
